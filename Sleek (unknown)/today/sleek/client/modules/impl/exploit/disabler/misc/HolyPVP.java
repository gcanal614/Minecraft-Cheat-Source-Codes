package today.sleek.client.modules.impl.exploit.disabler.misc;

import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C0CPacketInput;
import net.minecraft.util.ChatComponentText;
import today.sleek.base.event.impl.PacketEvent;
import today.sleek.base.event.impl.UpdateEvent;
import today.sleek.client.modules.impl.exploit.disabler.DisablerMode;
import today.sleek.client.utils.moshi.IPacketUtils;

import java.util.LinkedList;

public class HolyPVP extends DisablerMode
        implements IPacketUtils {

    public HolyPVP() {
        super("HolyPVP");
    }

    LinkedList<Packet<?>> packets = new LinkedList<>();

    @Override
    public void onUpdate(UpdateEvent e) {

        if (e.isPre())
            return;

        if (packets.size() % 19 == 0) {
            e.setPosY(0.1);
        }

        if (packets.size() > 300) {
            while (true) {
                if (packets.size() < 200)
                    return;
                sendPacketSilent(packets.poll());
            }
        }
    }

    @Override
    public void onPacket(PacketEvent e) {
        onCTransaction(e, transaction -> {
            if (packets.size() % 3 == 0) {
                sendPacket(new C0CPacketInput());
            }
            packets.add(transaction);
            e.setCancelled(true);
        });
        onCKeepAlive(e, c00PacketKeepAlive -> {
            packets.add(c00PacketKeepAlive);
            e.setCancelled(true);
        });
        onSPosLook(e, p -> {

            getPlayer().addChatMessage(
                    new ChatComponentText("Funny on tick "
                            + getPlayer().ticksExisted + " (" +
                            "S: " + packets.size() + ")"));
            double dx = p.x - getPlayer().posX;
            double dy = p.y - getPlayer().posY;
            double dz = p.z - getPlayer().posZ;
            double dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

            if (dist < 5) {
                sendPacket(new C03PacketPlayer.C06PacketPlayerPosLook(
                        p.x, p.y, p.z, p.yaw, p.pitch, true));
                e.setCancelled(true);
            }
        });
    }
}
